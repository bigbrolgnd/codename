# Replit API Integration - Theme CSS Update

This guide documents how to integrate with the Replit API to update `theme.css` files in tenant containers.

---

## Overview

The n8n **Theme Apply Workflow** calls the Replit API to write generated CSS to tenant containers, enabling published themes to take effect on live sites.

---

## Replit API Endpoints

### File Write Operation

**Endpoint:** `POST {container_url}/files/{filename}`

**Base URL Format:**
- Development: `https://replit.com/@{user}/{repl}`
- Production: Custom domain or Replit deployment URL

**Request Headers:**
```http
POST /files/theme.css HTTP/1.1
Host: replit.com
Authorization: Bearer {api_token}
Content-Type: application/json
X-Replit-Container-Id: {container_id}
User-Agent: codename-theme-orchestrator/1.0
```

**Request Body:**
```json
{
  "filePath": "theme.css",
  "content": "/* Generated CSS */\n:root {\n  --primary: #fff;\n}",
  "message": "Update theme CSS to version 5"
}
```

**Success Response (200):**
```json
{
  "success": true,
  "filePath": "theme.css",
  "size": 245,
  "revision": "abc123",
  "message": "File written successfully"
}
```

**Error Response (4xx/5xx):**
```json
{
  "success": false,
  "error": "Invalid API token",
  "code": "INVALID_AUTH"
}
```

---

## Authentication

### API Token Acquisition

Replit uses bearer token authentication. Tokens are obtained from:

1. **Replit Account Settings:**
   - Navigate to [replit.com](https://replit.com)
   - Go to **Account Settings** → **API Keys**
   - Generate new API key

2. **Repl-Specific Tokens:**
   - Open the repl
   - Go to **Settings** → **Secrets**
   - Add `REPLIT_API_TOKEN`

**Token Format:** Bearer token (32+ character string)

**Security Note:** Store API tokens encrypted in database. Use PostgreSQL `pgcrypto` extension:

```sql
-- Enable pgcrypto
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Encrypt token before storage
INSERT INTO tenants (api_token)
VALUES (pgp_sym_encrypt('replit_token_here', 'encryption_key'));

-- Decrypt when needed
SELECT pgp_sym_decrypt(api_token::bytea, 'encryption_key') as api_token
FROM tenants;
```

---

## Container URL Format

| Environment | URL Format | Example |
|-------------|-------------|---------|
| **Development** | `https://replit.com/@{user}/{replname}` | `https://replit.com/@john/tenant-abc123` |
| **Production** | Custom domain | `https://tenant-abc123.codename.app` |
| **Internal** | Repl ID | `replit:///repl_id/12345` |

**Note:** The n8n workflow uses the `container_url` field directly. Ensure stored URLs are accessible from your n8n instance.

---

## Error Handling

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `401 Unauthorized` | Invalid/expired API token | Regenerate token in Replit |
| `404 Not Found` | Container doesn't exist | Verify `container_id` is correct |
| `403 Forbidden` | Insufficient permissions | Check token has file write access |
| `413 Payload Too Large` | CSS exceeds size limit | Compress CSS or split into files |
| `503 Service Unavailable` | Replit API down | Retry with exponential backoff |

### Retry Strategy

The n8n workflow implements retry logic:
- **Max retries:** 3
- **Backoff:** Exponential (1s, 2s, 4s)
- **Timeout:** 30 seconds per request

---

## File Operations

### Write theme.css

```bash
curl -X POST '{container_url}/files/theme.css' \
  -H "Authorization: Bearer {api_token}" \
  -H "Content-Type: application/json" \
  -H "X-Replit-Container-Id: {container_id}" \
  -d '{
    "filePath": "theme.css",
    "content": "/* Generated CSS */\n:root { --primary: #fff; }",
    "message": "Update theme CSS"
  }'
```

### Read Existing File

```bash
curl -X GET '{container_url}/files/theme.css' \
  -H "Authorization: Bearer {api_token}" \
  -H "X-Replit-Container-Id: {container_id}"
```

### List Files in Directory

```bash
curl -X GET '{container_url}/files' \
  -H "Authorization: Bearer {api_token}" \
  -H "X-Replit-Container-Id: {container_id}"
```

---

## CSS File Structure

The `theme.css` file should be placed in the tenant container's web root:

```
{container_root}/
├── theme.css          ← Generated theme CSS (written by n8n)
├── index.html         ← Tenant site HTML
├── assets/
│   └── ...
└── components/
    └── ...
```

**CSS Content Format:**
```css
/* Generated by Design Studio */
:root {
  --background-primary: oklch(1 0 0);
  --text-primary: oklch(0.2156 0 0);
  --accent-color: oklch(0.5514 0.1451 247.0288);
}

.dark {
  --background-primary: oklch(0.2156 0 0);
  --text-primary: oklch(1 0 0);
  --accent-color: oklch(0.5514 0.1451 247.0288);
}
```

---

## Database Schema

### tenants Table (after migration)

```sql
CREATE TABLE public.tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_name TEXT NOT NULL,
  schema_name TEXT NOT NULL UNIQUE,
  status TEXT NOT NULL DEFAULT 'provisioning',

  -- Container fields (added in migration 019)
  container_url TEXT,
  container_id TEXT,
  api_token TEXT,  -- Store encrypted in production
  domain_name TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Sample Tenant Record

```sql
INSERT INTO public.tenants (
  business_name,
  schema_name,
  status,
  container_url,
  container_id,
  api_token,
  domain_name
) VALUES (
  'My Business',
  'tenant_abc123',
  'active',
  'https://replit.com/@codename/tenant-abc123',
  'tenant-abc123-container',
  'rpl_xxxxxxxxxxxxx',  -- Encrypted in production
  'mybusiness.codename.app'
);
```

---

## Testing Integration

### 1. Test Tenant Creation

Run migration `020_create_test_tenant.sql` in Supabase SQL Editor.

### 2. Test n8n Workflow

```bash
curl -X POST https://n8n.b2ainvestments.com/webhook/theme-apply \
  -H "Content-Type: application/json" \
  -d '{
    "event": "THEME_PUBLISHED",
    "payload": {
      "tenantId": "tenant_theme_test",
      "css": "/* Test CSS */\n:root { --test: value; }",
      "version": 1,
      "styles": { "light": {}, "dark": {} },
      "hslAdjustments": { "hueShift": 0, "saturationScale": 1, "lightnessScale": 1 },
      "generatedAt": "2026-01-13T06:30:00Z"
    }
  }'
```

### 3. Verify File Was Written

If using Replit:
1. Navigate to the repl
2. Check `theme.css` file exists
3. Verify content matches sent CSS

---

## Security Considerations

1. **Encrypt API tokens** in database using `pgcrypto`
2. **Use HTTPS** for all Replit API calls
3. **Validate CSS size** before sending (max 1MB recommended)
4. **Audit log** all theme deployments (n8n workflow does this)
5. **Rate limit** API calls to prevent abuse
6. **Rotate tokens** periodically

---

## Troubleshooting

### Workflow Fails Silently

Check n8n execution logs:
1. Open workflow in n8n
2. Click **Executions** tab
3. Find failed execution
4. Review node outputs

### Container Not Found

Verify tenant record:
```sql
SELECT schema_name, container_url, container_id, status
FROM public.tenants
WHERE schema_name = 'tenant_theme_test';
```

### API Token Invalid

Regenerate token in Replit and update database:
```sql
UPDATE public.tenants
SET api_token = 'new_token_here'
WHERE schema_name = 'tenant_theme_test';
```

---

## Next Steps

1. Run migrations `019` and `020` in Supabase
2. **Import n8n workflow using n8n-manager skill**: "Import theme-apply-workflow.json into n8n"
3. Configure PostgreSQL credentials in n8n UI (see Credential Setup below)
4. **Activate workflow**: "Activate the Theme Apply workflow"
5. **Get webhook URL**: "Get webhook URL for Theme Apply"
6. Test with sample tenant
7. Verify Replit container receives theme.css
8. Set up monitoring for failed deployments

---

## Quick Reference: n8n-manager Skill

Use the `n8n-manager` skill for automated workflow operations:

| Operation | Command |
|-----------|---------|
| Import workflow | "Import theme-apply-workflow.json into n8n" |
| Activate workflow | "Activate the Theme Apply workflow" |
| Get webhook URL | "Get webhook URL for Theme Apply" |
| List workflows | "List all n8n workflows" |
